name: Deploy to Production

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  merge-and-deploy:
    name: Merge to Main & Deploy
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Merge develop to main
      run: |
        git fetch origin main
        git checkout main
        git merge origin/develop --no-ff -m "ðŸ”„ Auto merge develop to main

        Automatically merged from develop branch

        Triggered by: ${{ github.sha }}
        Actor: ${{ github.actor }}"
        git push origin main

    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        script: |
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd ~/chessok

          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° (main ë¸Œëžœì¹˜)
          git pull origin main

          # í™˜ê²½ ë³€ìˆ˜ ë³µì‚¬
          cp .envs/.env.prod .env

          # Docker Composeë¡œ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          docker compose -f docker-compose.prod.yml down
          docker compose -f docker-compose.prod.yml up -d --build

          # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
          docker compose -f docker-compose.prod.yml exec -T web uv run python manage.py migrate --noinput

          # Static íŒŒì¼ ìˆ˜ì§‘
          docker compose -f docker-compose.prod.yml exec -T web uv run python manage.py collectstatic --noinput

          # ë¶ˆí•„ìš”í•œ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
          docker system prune -f

    - name: Health Check
      run: |
        echo "Waiting for application to start..."
        sleep 15
        echo "Health check completed"

    - name: Deployment Summary
      if: success()
      run: |
        echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **í™˜ê²½**: production" >> $GITHUB_STEP_SUMMARY
        echo "- **develop ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **main ë¸Œëžœì¹˜**: ìžë™ ì—…ë°ì´íŠ¸ë¨" >> $GITHUB_STEP_SUMMARY
        echo "- **ë°°í¬ ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure
      if: failure()
      run: |
        echo "## âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "merge ë˜ëŠ” ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        echo "ì¶©ëŒì´ ë°œìƒí•œ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ í•´ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: merge-and-deploy
    if: failure()
    environment:
      name: production

    steps:
    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        script: |
          cd ~/chessok

          # ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë¡¤ë°±
          git reset --hard HEAD~1

          # í™˜ê²½ ë³€ìˆ˜ ë³µì‚¬
          cp .envs/.env.prod .env

          # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          docker compose -f docker-compose.prod.yml down
          docker compose -f docker-compose.prod.yml up -d --build

    - name: Rollback Summary
      run: |
        echo "## âš ï¸ ë¡¤ë°± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ë°°í¬ ì‹¤íŒ¨ë¡œ ì¸í•´ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
