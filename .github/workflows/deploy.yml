name: Deploy to EC2

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set deployment variables
      id: vars
      run: |
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "branch=main" >> $GITHUB_OUTPUT
          echo "env_file=.env.prod" >> $GITHUB_OUTPUT
          echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
        else
          echo "branch=develop" >> $GITHUB_OUTPUT
          echo "env_file=.env.dev" >> $GITHUB_OUTPUT
          echo "compose_file=docker-compose.dev.yml" >> $GITHUB_OUTPUT
          echo "environment=development" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        script: |
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd ~/chessok

          # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git pull origin ${{ steps.vars.outputs.branch }}

          # í™˜ê²½ ë³€ìˆ˜ ë³µì‚¬
          cp .envs/${{ steps.vars.outputs.env_file }} .env

          # Docker Composeë¡œ ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          docker-compose -f ${{ steps.vars.outputs.compose_file }} down
          docker-compose -f ${{ steps.vars.outputs.compose_file }} up -d --build

          # ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
          docker-compose -f ${{ steps.vars.outputs.compose_file }} exec -T web uv run python manage.py migrate --noinput

          # Static íŒŒì¼ ìˆ˜ì§‘
          docker-compose -f ${{ steps.vars.outputs.compose_file }} exec -T web uv run python manage.py collectstatic --noinput

          # ë¶ˆí•„ìš”í•œ Docker ë¦¬ì†ŒìŠ¤ ì •ë¦¬
          docker system prune -f

    - name: Health Check
      run: |
        echo "Waiting for application to start..."
        sleep 15
        echo "Health check completed"

    - name: Deployment Summary
      if: success()
      run: |
        echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **í™˜ê²½**: ${{ steps.vars.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë¸Œëžœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ë°°í¬ ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure
      if: failure()
      run: |
        echo "## âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}

    steps:
    - name: Set rollback variables
      id: rollback_vars
      run: |
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "env_file=.env.prod" >> $GITHUB_OUTPUT
          echo "compose_file=docker-compose.prod.yml" >> $GITHUB_OUTPUT
        else
          echo "env_file=.env.dev" >> $GITHUB_OUTPUT
          echo "compose_file=docker-compose.dev.yml" >> $GITHUB_OUTPUT
        fi

    - name: Rollback deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: ${{ secrets.EC2_SSH_PORT || 22 }}
        script: |
          cd ~/chessok

          # ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë¡¤ë°±
          git reset --hard HEAD~1

          # í™˜ê²½ ë³€ìˆ˜ ë³µì‚¬
          cp .envs/${{ steps.rollback_vars.outputs.env_file }} .env

          # ì„œë¹„ìŠ¤ ìž¬ì‹œìž‘
          docker-compose -f ${{ steps.rollback_vars.outputs.compose_file }} down
          docker-compose -f ${{ steps.rollback_vars.outputs.compose_file }} up -d --build

    - name: Rollback Summary
      run: |
        echo "## âš ï¸ ë¡¤ë°± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ë°°í¬ ì‹¤íŒ¨ë¡œ ì¸í•´ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
