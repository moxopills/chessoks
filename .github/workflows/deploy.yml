name: Deploy to Production

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

jobs:
  merge-and-deploy:
    name: Merge to Main & Deploy
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Merge develop to main
      run: |
        git fetch origin main
        git checkout main
        git merge origin/develop --no-ff -m "ðŸ”„ Auto merge develop to main

        Automatically merged from develop branch

        Triggered by: ${{ github.sha }}
        Actor: ${{ github.actor }}"
        git push origin main

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" | base64 -d > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to Production Server
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          cd ~/chessok
          git pull origin main
          cp .envs/.env.prod .env
          docker compose -f docker-compose.prod.yml down
          docker compose -f docker-compose.prod.yml up -d --build
          docker compose -f docker-compose.prod.yml exec -T web uv run python manage.py migrate --noinput
          docker compose -f docker-compose.prod.yml exec -T web uv run python manage.py collectstatic --noinput
          docker system prune -f
        ENDSSH

    - name: Health Check
      run: |
        echo "Waiting for application to start..."
        sleep 15
        echo "Health check completed"

    - name: Deployment Summary
      if: success()
      run: |
        echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **í™˜ê²½**: production" >> $GITHUB_STEP_SUMMARY
        echo "- **develop ì»¤ë°‹**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **main ë¸Œëžœì¹˜**: ìžë™ ì—…ë°ì´íŠ¸ë¨" >> $GITHUB_STEP_SUMMARY
        echo "- **ë°°í¬ ì‹œê°„**: $(date)" >> $GITHUB_STEP_SUMMARY

    - name: Notify on failure
      if: failure()
      run: |
        echo "## âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "merge ë˜ëŠ” ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        echo "ì¶©ëŒì´ ë°œìƒí•œ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ í•´ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: merge-and-deploy
    if: failure()
    environment:
      name: production

    steps:
    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" | base64 -d > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key

    - name: Rollback deployment
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
          cd ~/chessok
          git reset --hard HEAD~1
          cp .envs/.env.prod .env
          docker compose -f docker-compose.prod.yml down
          docker compose -f docker-compose.prod.yml up -d --build
        ENDSSH

    - name: Rollback Summary
      run: |
        echo "## âš ï¸ ë¡¤ë°± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ë°°í¬ ì‹¤íŒ¨ë¡œ ì¸í•´ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
