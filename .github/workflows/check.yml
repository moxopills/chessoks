name: Code Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        uv sync --all-extras

    - name: Ruff lint check
      run: |
        uv run ruff check .

    - name: Black format check
      run: |
        uv run black --check .

    - name: isort import check
      run: |
        uv run isort --check-only .

    - name: MyPy type check
      run: |
        uv run mypy . || echo "Warning: Type check issues found"

    - name: Summary
      if: success()
      run: |
        echo "✅ Ruff 린트 체크 통과" >> $GITHUB_STEP_SUMMARY
        echo "✅ Black 포맷 체크 통과" >> $GITHUB_STEP_SUMMARY
        echo "✅ isort import 정렬 체크 통과" >> $GITHUB_STEP_SUMMARY
        echo "✅ MyPy 타입 체크 완료" >> $GITHUB_STEP_SUMMARY

  test:
    name: Test
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4

    - uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: uv sync --all-extras

    - name: Run tests
      env:
        SECRET_KEY: "test-secret-key-for-ci"
        DEBUG: "True"
        DB_NAME: testdb
        DB_USER: test
        DB_PASSWORD: test
        DB_HOST: localhost
        DB_PORT: 5432
        REDIS_HOST: localhost
        REDIS_PORT: 6379
      run: uv run pytest --cov=. --cov-report=term

    - name: Summary
      if: success()
      run: echo "✅ 테스트 및 커버리지 통과" >> $GITHUB_STEP_SUMMARY

  security:
    name: Security Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        uv sync

    - name: Check for secrets in code
      run: |
        echo "Checking for potential secrets..."
        ! grep -r "SECRET_KEY.*=.*['\"]django-insecure" --include="*.py" config/ || echo "Warning: Hardcoded SECRET_KEY found"

    - name: Check Django security settings
      env:
        SECRET_KEY: "test-secret-key-for-ci"
        DEBUG: "False"
        ALLOWED_HOSTS: "localhost"
        DB_NAME: "testdb"
        DB_USER: "test"
        DB_PASSWORD: "test"
        DB_HOST: "localhost"
        DB_PORT: "5432"
      run: |
        uv run python manage.py check --deploy

    - name: Summary
      if: success()
      run: |
        echo "✅ 보안 체크 완료" >> $GITHUB_STEP_SUMMARY
        echo "✅ Django 배포 설정 검증 완료" >> $GITHUB_STEP_SUMMARY

  migrations:
    name: Migrations Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        uv sync

    - name: Check for missing migrations
      env:
        SECRET_KEY: "test-secret-key-for-ci"
        DEBUG: "True"
        DB_NAME: "testdb"
        DB_USER: "test"
        DB_PASSWORD: "test"
        DB_HOST: "localhost"
        DB_PORT: "5432"
      run: |
        uv run python manage.py makemigrations --check --dry-run

    - name: Summary
      if: success()
      run: |
        echo "✅ 마이그레이션 체크 통과" >> $GITHUB_STEP_SUMMARY
